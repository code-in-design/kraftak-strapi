name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: 13.209.112.166
  EC2_USER: ec2-user
  APP_NAME: kraftak-strapi

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add Host Key to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1
          chmod 644 ~/.ssh/known_hosts

      - name: SCP - Copy dist to EC2
        run: scp -r dist ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/${{ env.EC2_USER }}/${{ env.APP_NAME }}/

      - name: SSH - Update code and restart PM2
        run: |
          ssh ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          cd /home/ec2-user/kraftak-strapi

          # 최신 소스 코드 pull (dist 제외)
          git fetch origin
          git checkout origin/main -- src config package.json yarn.lock ecosystem.config.js tsconfig.json

          # 의존성 설치
          yarn install --frozen-lockfile --production

          # PM2 재시작
          pm2 restart ecosystem.config.js --only kraftak-prod --env production
          EOF

      - name: Wait for deployment to stabilize
        run: sleep 15

      - name: Health Check
        run: |
          echo "Checking health endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ env.EC2_HOST }}:1337" || echo "000")
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 302 ]; then
            echo "Health check passed! Status: $RESPONSE"
          else
            echo "Health check failed! Status: $RESPONSE"
            exit 1
          fi
